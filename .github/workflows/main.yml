name: Build - Saturn

on:
  push:
    branches:
      - "**"
    paths-ignore:
      - 'pubspec.yaml'
      - 'README.md'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  VERSION_BUMP:
    name: Bump Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check if version bump should be skipped
        id: check_skip
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"
          if [[ "$COMMIT_MSG" == *"--no-bump"* ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping version bump"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Proceeding with version bump"
          fi
      
      - name: Bump version
        if: steps.check_skip.outputs.skip != 'true'
        run: |
          CURRENT_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
          echo "Current version: $CURRENT_VERSION"
          
          IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
          NEW_PATCH=$((patch + 1))
          NEW_VERSION="$major.$minor.$NEW_PATCH"
          echo "New version: $NEW_VERSION"
          
          sed -i "s/^version: .*/version: $NEW_VERSION/" pubspec.yaml
          
          echo "Updated pubspec.yaml:"
          grep '^version:' pubspec.yaml
      
      - name: Commit version bump
        if: steps.check_skip.outputs.skip != 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Automated Version Bump
          push_options: '--force'
          skip_dirty_check: true

  LINUXANDROID:
    name: Linux & Android
    runs-on: ubuntu-22.04
    environment: workflow
    needs: VERSION_BUMP
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
      
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.4"
          cache: true
      - name: Create secret files
        run: |
          pwd
          ls -la
          mkdir -p lib/utils
          mkdir -p android
          echo "${{ secrets.env }}" > lib/.env
          echo "${{ secrets.envgdart }}" > lib/utils/env.g.dart
          echo "${{ secrets.keyproperties }}" > android/key.properties
          echo "${{ secrets.uploadkeystore }}" | base64 -d > android/app/upload-keystore.jks
          echo "Created files:"
          ls -la lib/
          ls -la lib/utils/
          ls -la android/
      - name: Install Flutter dependencies
        run: flutter pub get
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libmpv-dev
      - name: Install dependencies for AppImage
        run: |
          sudo apt install -y locate
          wget -O appimagetool "https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool
          sudo mv appimagetool /usr/local/bin/
      - name: Install Fastforge
        run: dart pub global activate fastforge
        
      - name: Build and release
        run: fastforge release --name linux
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ runner.os }}
          path: dist/

  MACOSIOS:
    name: MacOS & iOS
    runs-on: macos-latest
    environment: workflow
    needs: VERSION_BUMP
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.4"
          cache: true

      - name: Install appdmg
        run: npm install -g appdmg

      - name: Create secret files
        run: |
          pwd
          ls -la
          mkdir -p lib/utils
          echo "${{ secrets.env }}" > lib/.env
          echo "${{ secrets.envgdart }}" > lib/utils/env.g.dart
          echo "Created files:"
          ls -la lib/
          ls -la lib/utils/

      - name: Install Flutter dependencies
        run: flutter pub get

      - name: Install Fastforge
        run: dart pub global activate fastforge
        
      - name: Build and release
        run: fastforge release --name macos

      - name: Build iOS app
        run: flutter build ios --release --no-codesign

      - name: Get version from pubspec.yaml
        id: get_version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Package iOS IPA
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          mkdir -p "dist/$VERSION"
          mkdir -p Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          zip -r "dist/$VERSION/saturn-$VERSION-ios.ipa" Payload
          rm -rf Payload
          echo "Packaged IPA:"
          ls -la "dist/$VERSION/"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ runner.os }}
          path: dist/

  WINDOWS:
    name: Windows
    runs-on: windows-latest
    environment: workflow
    needs: VERSION_BUMP
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.4"
          cache: true

      - name: Create secret files
        shell: bash
        run: |
          pwd
          ls -la
          mkdir -p lib/utils
          echo "${{ secrets.env }}" > lib/.env
          echo "${{ secrets.envgdart }}" > lib/utils/env.g.dart
          echo "Created files:"
          ls -la lib/
          ls -la lib/utils/

      - name: Install Flutter dependencies
        run: flutter pub get

      - name: Install Fastforge
        run: dart pub global activate fastforge
        
      - name: Build and release
        run: fastforge release --name windows

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ runner.os }}
          path: dist


  CREATE_RELEASE:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [LINUXANDROID, MACOSIOS, WINDOWS]
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Get version from pubspec.yaml
        id: get_version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          mkdir -p release_assets
          
          # Find and move all files from the version folder inside each artifact
          find artifacts -type f -path "*/$VERSION/*" -exec cp {} release_assets/ \;
          
          echo "Release assets:"
          ls -la release_assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: Saturn v${{ steps.get_version.outputs.version }}
          body: |
            Changes: ${{ github.event.head_commit.url }}
          files: release_assets/*
          draft: false
          prerelease: false